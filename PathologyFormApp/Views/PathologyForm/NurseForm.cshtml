@model PathologyFormApp.ViewModels.NurseFormViewModel

@{
    Layout = "_Layout";
    ViewData["Title"] = "Nurse Form";
}

<div class="container mt-4 hospital-form">
    <form asp-action="NurseForm" enctype="multipart/form-data" method="post" class="needs-validation" novalidate>
        <div asp-validation-summary="All" class="text-danger"></div>

        <!-- Patient Information Section -->
        <fieldset class="form-section border p-3 mb-4">
            <legend class="form-section-title w-auto px-2">Patient Information</legend>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-md-6 form-group">
                            <label asp-for="UHID" class="form-label required-field">UHID:</label>
                            <input asp-for="UHID" class="form-control form-control-sm" required />
                            <span asp-validation-for="UHID" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 form-group">
                            <label asp-for="LabRefNo" class="form-label required-field">Lab Ref. No.:</label>
                            <input asp-for="LabRefNo" class="form-control form-control-sm" required />
                            <span asp-validation-for="LabRefNo" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-md-6 form-group">
                            <label asp-for="Date" class="form-label required-field">Date:</label>
                            <input asp-for="Date" class="form-control form-control-sm" type="date" required />
                            <span asp-validation-for="Date" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 form-group">
                            <label asp-for="Age" class="form-label required-field">Age:</label>
                            <input asp-for="Age" class="form-control form-control-sm" type="number" required />
                            <span asp-validation-for="Age" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-md-8 form-group">
                            <label asp-for="Name" class="form-label required-field">Name:</label>
                            <input asp-for="Name" class="form-control form-control-sm" required />
                            <span asp-validation-for="Name" class="text-danger small"></span>
                        </div>
                        <div class="col-md-4 form-group">
                            <label asp-for="Gender" class="form-label required-field">Gender:</label>
                            <select asp-for="Gender" class="form-select form-select-sm" required>
                                <option value="">Select</option>
                                <option>Male</option>
                                <option>Female</option>
                            </select>
                            <span asp-validation-for="Gender" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-md-6 form-group">
                            <label asp-for="CRNo" class="form-label">CR No.:</label>
                            <input asp-for="CRNo" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-6 form-group">
                            <label asp-for="OPD_IPD" class="form-label">OPD / IPD:</label>
                            <select asp-for="OPD_IPD" class="form-select form-select-sm" id="opdIpdDropdown">
                                <option value="">Select</option>
                                <option>OPD</option>
                                <option>IPD</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-md-12 form-group">
                            <label asp-for="IPDNo" class="form-label" id="opdIpdLabel">IPD/OPD No.:</label>
                            <input asp-for="IPDNo" class="form-control form-control-sm" id="opdIpdInput" placeholder="Enter Number" />
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-md-12 form-group">
                            <label asp-for="Consultant" class="form-label required-field">Consultant:</label>
                            <input asp-for="Consultant" class="form-control form-control-sm" required />
                            <span asp-validation-for="Consultant" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 border-start ps-4">
                    <div class="form-group mb-3">
                        <label class="form-label">For Obs / Gynae Cases:</label>
                        <div class="row g-2">
                            <div class="col-6 form-group">
                                <label asp-for="MensesOnset" class="form-label">Menses onset:</label>
                                <input asp-for="MensesOnset" class="form-control form-control-sm" type="number" />
                            </div>
                            <div class="col-6 form-group">
                                <label class="form-label">every (days):</label>
                                <input asp-for="MensesCycle" class="form-control form-control-sm" type="number" />
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-6 form-group">
                                <label asp-for="LastingDays" class="form-label">Lasting (days):</label>
                                <input asp-for="LastingDays" class="form-control form-control-sm" type="number" />
                            </div>
                            <div class="col-6 form-group">
                                <label asp-for="Character" class="form-label">Character:</label>
                                <input asp-for="Character" class="form-control form-control-sm" />
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-4 form-group">
                                <label asp-for="LMP" class="form-label">LMP:</label>
                                <input asp-for="LMP" class="form-control form-control-sm" />
                            </div>
                            <div class="col-4 form-group">
                                <label asp-for="Gravida" class="form-label">Gravida:</label>
                                <input asp-for="Gravida" class="form-control form-control-sm" />
                            </div>
                            <div class="col-4 form-group">
                                <label asp-for="Para" class="form-label">Para:</label>
                                <input asp-for="Para" class="form-control form-control-sm" />
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-6 form-group">
                                <label asp-for="MenopauseAge" class="form-label">Menopause Age:</label>
                                <input asp-for="MenopauseAge" class="form-control form-control-sm" type="number" />
                            </div>
                            <div class="col-6 form-group">
                                <label asp-for="MenopauseYears" class="form-label">Years:</label>
                                <input asp-for="MenopauseYears" class="form-control form-control-sm" type="number" />
                            </div>
                        </div>
                        <div class="form-group mt-2">
                            <label asp-for="HormoneTherapy" class="form-label">Hormone Therapy:</label>
                            <input asp-for="HormoneTherapy" class="form-control form-control-sm" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12 form-group">
                    <label asp-for="ClinicalDiagnosis" class="form-label">Clinical Diagnosis:</label>
                    <textarea asp-for="ClinicalDiagnosis" class="form-control form-control-sm" rows="2"></textarea>
                </div>
            </div>
        </fieldset>

        <!-- Name of Specimens Section -->
        <fieldset class="form-section border p-3 mb-4">
            <legend class="form-section-title w-auto px-2">Name of Specimens</legend>
            <div class="form-group mb-3">
                <label asp-for="SpecimenName" class="form-label">Name of Specimen 1:</label>
                <div class="input-group input-group-sm">
                    <select id="specimenDropdown" asp-for="SpecimenName" class="form-select form-select-sm"></select>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="addSpecimenButton">Add</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="removeSpecimenButton">Remove</button>
                </div>
                <input type="text" id="newSpecimenInput" class="form-control form-control-sm mt-2" placeholder="Type new specimen and click Add" />
                <span asp-validation-for="SpecimenName" class="text-danger small"></span>
            </div>
            <div class="row g-2 mb-3">
                <div class="col-md-6 form-group">
                    <label asp-for="DateTimeOfCollection" class="form-label">Date & Time of Collection:</label>
                    <input asp-for="DateTimeOfCollection" class="form-control form-control-sm" type="datetime-local" />
                </div>
            </div>
        </fieldset>

        <!-- Clinical Data Section -->
        <fieldset class="form-section border p-3 mb-4">
            <legend class="form-section-title w-auto px-2">Clinical Data</legend>
            <div class="form-group mb-3">
                <label asp-for="XRayUSGCTMRIFindings" class="form-label">X-Ray/US/CT/MRI Findings:</label>
                <textarea asp-for="XRayUSGCTMRIFindings" class="form-control form-control-sm" rows="2"></textarea>
            </div>
            <div class="form-group mb-3">
                <label asp-for="LaboratoryFindings" class="form-label">Laboratory Findings:</label>
                <textarea asp-for="LaboratoryFindings" class="form-control form-control-sm" rows="2"></textarea>
            </div>
            <div class="form-group mb-3">
                <label asp-for="OperativeFindings" class="form-label">Operative Findings:</label>
                <textarea asp-for="OperativeFindings" class="form-control form-control-sm" rows="2"></textarea>
            </div>
            <div class="form-group mb-3">
                <label asp-for="PostOperativeDiagnosis" class="form-label">Postoperative Diagnosis:</label>
                <textarea asp-for="PostOperativeDiagnosis" class="form-control form-control-sm" rows="2"></textarea>
            </div>
            <div class="form-group mb-3">
                <label asp-for="PreviousHPCytReport" class="form-label">Previous HP/Cyt. Report with Lab Ref. No.:</label>
                <textarea asp-for="PreviousHPCytReport" class="form-control form-control-sm" rows="2"></textarea>
            </div>
        </fieldset>

        <!-- Signature & Upload Section -->
        <fieldset class="form-section border p-3 mb-4">
            <legend class="form-section-title w-auto px-2">Signature & Upload</legend>
            <div class="row mb-3">
                <div class="col-md-6 form-group">
                    <label class="form-label">Signature:</label>
                    <div id="signature-pad" class="signature-pad border rounded">
                        <canvas style="width: 100%; height: 150px;"></canvas>
                        <div class="pad-footer">
                            <small class="description text-muted">Sign above</small>
                            <button type="button" class="btn btn-sm btn-outline-secondary clear-btn" data-action="clear">Clear</button>
                        </div>
                    </div>
                    <input type="hidden" asp-for="Signature" data-action="save" />
                </div>
                <div class="col-md-6 form-group">
                    <label class="form-label">Upload File:</label>
                    <input type="file" asp-for="UploadedFiles" class="form-control form-control-sm" multiple accept=".pdf,.jpeg,.jpg,.png,.doc,.docx,.xls,.xlsx,.txt,.bmp,.gif,.tiff,.csv,.ppt,.pptx,.zip,.rar,.7z,.rtf,.odt,.ods,.odp,.svg,.webp,.heic,.jfif,.mp4,.avi,.mov,.wmv,.mkv,.mp3,.wav,.aac,.ogg,.flac,.m4a,.json,.xml,.html,.htm,.md,.log,.ini,.yml,.yaml,.psd,.ai,.eps,.indd,.xd,.sketch,.fig,.apk,.exe,.dll,.bat,.sh,.py,.js,.ts,.css,.scss,.less,.php,.rb,.go,.swift,.kt,.dart,.c,.cpp,.h,.hpp,.cs,.vb,.sql,.db,.sqlite,.accdb,.mdb,.bak,.iso,.img,.dmg,.pkg,.deb,.rpm,.msi,.cab,.bin,.dat,.tmp,.torrent" id="nurseFileUploadInput" />
                    <div id="nurseFilePreviewArea" class="mt-2 uploaded-files"></div>
                </div>
            </div>
        </fieldset>

        <div class="text-end">
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <script>
        $(document).ready(function() {
            try {
                // Signature Pad
                const canvas = document.querySelector("canvas");
                const signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)'
                });

                const clearButton = document.querySelector("[data-action=clear]");
                const saveButton = document.querySelector("[data-action=save]");
                
                clearButton.addEventListener("click", () => {
                    signaturePad.clear();
                    saveButton.value = '';
                });

                signaturePad.addEventListener("endStroke", () => {
                    if (!signaturePad.isEmpty()) {
                        saveButton.value = signaturePad.toDataURL(); // Save as base64
                    }
                });
                
                // Fetch specimen types from the backend and populate the dropdown
                function fetchSpecimens() {
                    $.ajax({
                        url: '/Specimen/GetAll',
                        type: 'GET',
                        success: function(data) {
                            var dropdown = $('#specimenDropdown');
                            dropdown.empty();
                            if (Array.isArray(data) && data.length > 0) {
                                data.forEach(function(item) {
                                    if (item && typeof item.name !== 'undefined') {
                                        dropdown.append($('<option>', { value: item.name, text: item.name }));
                                    }
                                });
                            } else {
                                console.warn("No specimen data returned or data is not in the expected format.");
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.error("Failed to fetch specimens:", textStatus, errorThrown);
                            // Display a user-friendly error message on the page
                            $('#specimenDropdown').closest('.form-group').append('<div class="text-danger small mt-1">Error: Could not load the specimen list.</div>');
                        }
                    });
                }
                fetchSpecimens();

                // Add new specimen to dropdown
                $('#addSpecimenButton').on('click', function() {
                    var newSpecimen = $('#newSpecimenInput').val();
                    if (newSpecimen) {
                        $('#specimenDropdown').append($('<option>', { value: newSpecimen, text: newSpecimen, selected: true }));
                        $('#newSpecimenInput').val('');
                    }
                });

                // Remove selected specimen from dropdown
                $('#removeSpecimenButton').on('click', function() {
                    $('#specimenDropdown option:selected').remove();
                });

                // File upload preview and removal (before submit)
                const fileInput = $('#nurseFileUploadInput');
                const filePreviewArea = $('#nurseFilePreviewArea');
                let filesToUpload = [];

                fileInput.on('change', function() {
                    filesToUpload = Array.from(this.files);
                    renderFilePreview();
                });

                function renderFilePreview() {
                    filePreviewArea.empty();
                    if (filesToUpload.length === 0) return;
                    filesToUpload.forEach((file, idx) => {
                        const ext = file.name.split('.').pop().toLowerCase();
                        const isImage = ["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext);
                        let preview = '';
                        if (isImage) {
                            const url = URL.createObjectURL(file);
                            preview = `<img src="${url}" style="max-width:60px;max-height:60px;object-fit:contain;" class="me-2 mb-1" onload="URL.revokeObjectURL(this.src)" />`;
                        } else {
                            preview = `<i class='fas fa-file-alt fa-2x me-2 mb-1'></i>`;
                        }
                        filePreviewArea.append(`
                            <div class='file-preview-item d-inline-block border rounded p-2 m-1 text-center' style='width:120px;'>
                                ${preview}<div class='small text-truncate'>${file.name}</div>
                                <button type='button' class='btn btn-sm btn-danger w-100 mt-1 remove-file-btn' data-idx='${idx}'>Remove</button>
                            </div>
                        `);
                    });
                }

                filePreviewArea.on('click', '.remove-file-btn', function() {
                    const idx = $(this).data('idx');
                    filesToUpload.splice(idx, 1);
                    // Update the FileList in the input
                    const dataTransfer = new DataTransfer();
                    filesToUpload.forEach(f => dataTransfer.items.add(f));
                    fileInput[0].files = dataTransfer.files;
                    renderFilePreview();
                });
            } catch (e) {
                console.error("A critical JavaScript error occurred:", e);
                alert("A client-side error occurred that may prevent saving. Please check the browser console (F12) for details. Error: " + e.message);
            }
        });
    </script>
} 